version: 0.1             
component: build
timeoutInSeconds: 1000
failImmediatelyOnError: true
shell: bash           

steps:
  - type: Command
    name: "Set Environment"
    command: |
      npx zx scripts/setenv.mjs
  - type: Command
    name: "Print .env.json"
    command: |
      cat .env.json
  - type: Command
    name: "Print OCI_OCIR_TOKEN"
    command: |
      echo $OCI_OCIR_TOKEN
  - type: Command
    name: "Docker Login"
    command: |
      cat .env.json | jq '.containerRegistryToken' | docker login $(cat .env.json | jq '.containerRegistryURL') --username $(cat .env.json | jq '.containerRegistryUser') --password-stdin
  - type: Command
    name: "Build hello-server"
    command: |
      npx zx scripts/build.mjs hello-server
  - type: Command
    name: "Build auth-server"
    command: |
      npx zx scripts/build.mjs auth-server
  - type: Command
    name: "Check kubeconfig file"
    command: |
      file $(pwd)/tf/generated/kubeconfig
  - type: Command
    name: "Check docker images"
    command: |
      docker images | grep server

outputArtifacts:
  - name: hello-server
    type: DOCKER_IMAGE
    location: hello-server
  - name: oke-kubeconfig
    type: BINARY
    location: ${OCI_WORKSPACE_DIR}/tf/generated/kubeconfig