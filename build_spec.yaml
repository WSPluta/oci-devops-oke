version: 0.1             
component: build
timeoutInSeconds: 1000
failImmediatelyOnError: true
shell: bash

env:
  exportedVariables:
    - HELLO_VERSION
    - AUTH_VERSION
    - BUILDRUN_HASH

steps:
  - type: Command
    name: "Install libraries"
    command: |
      yum update -y
      yum install jq -y
  - type: Command
    name: "Set Environment"
    command: |
      npx zx scripts/setenv.mjs
  - type: Command
    name: "Print .env.json"
    command: |
      cat .env.json
  - type: Command
    name: "Print hello-server version"
    command: |
      export BUILDRUN_HASH=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7`
      export HELLO_VERSION=$(cat src/hello-server/package.json| jq .version | tr -d '/"')
      export AUTH_VERSION=$(cat src/auth-server/package.json| jq .version | tr -d '/"')
  - type: Command
    name: "Build hello-server"
    command: |
      npx zx scripts/build.mjs hello-server
  - type: Command
    name: "Build auth-server"
    command: |
      npx zx scripts/build.mjs auth-server

outputArtifacts:
  - name: hello_server
    type: DOCKER_IMAGE
    location: hello-server:${HELLO_VERSION}
  - name: auth_server
    type: DOCKER_IMAGE
    location: auth-server:${AUTH_VERSION}
  # - name: hello_deployment_yaml
  #   type: BINARY
  #   location: ${OCI_PRIMARY_SOURCE_DIR}/k8s/hello-server/hello-server.yaml