version: 0.1
component: command
timeoutInSeconds: 25000
failImmediatelyOnError: true
shell: bash

env:
  variables:
    NODE_VERSION: v18.16.1
    DISTRO: linux-x64

steps:
  - type: Command
    name: "Install nodejs"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      yum --disablerepo=ol7_oci_included install -y oracle-nodejs-release-el7 oracle-release-el7
      yum --disablerepo=ol7_oci_included install -y nodejs
      node -v
  - type: Command
    name: "Node version"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      node -v
      npm version
      npx -v
  - type: Command
    name: "Git Clone"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      git clone ${github_repo_url}
  - type: Command
    name: "Setup kube config and get nodes"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      oci ce cluster create-kubeconfig --cluster-id ${cluster} \
        --file $HOME/.kube/config --region ${region} --token-version 2.0.0  \
        --kube-endpoint PUBLIC_ENDPOINT
  - type: Command
    name: "Custom Kustomize with versions"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      echo $(pwd)
      cd /workspace/oci-devops-oke
      npx zx scripts/kustom.mjs
  - type: Command
    name: "Apply kustomization"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      kubectl apply -k ./oci-devops-oke/k8s/overlay/prod
  - type: Command
    name: "Wait for Load Balancer (sleep)"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      sleep 60
  - type: Command
    name: "Get Load Balancer IP address"
    shell: bash
    timeoutInSeconds: 3000
    command: |
      LB_PUBLIC_IP=$(kubectl get svc ingress-nginx-controller -n ingress-nginx --template="{{range .status.loadBalancer.ingress}}{{.ip}}{{end}}")
      echo "http://$LB_PUBLIC_IP/"